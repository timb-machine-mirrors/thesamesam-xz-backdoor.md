# FAQ on the xz-utils backdoor

There's a lot we don't know. This is a living document - please treat it as such.

## Design
* The backdoor has several components:
  - Malicious version of `build-to-host.m4` in the release dist tarballs.
  - Crafted test data in `tests/`
    - tests/files/bad-3-corrupt_lzma2.xz ([cf44e4b7f5dfdbf8c78aef377c10f71e274f63c0](https://github.com/tukaani-project/xz/commit/cf44e4b7f5dfdbf8c78aef377c10f71e274f63c0), [74b138d2a6529f2c07729d7c77b1725a8e8b16f1](https://github.com/tukaani-project/xz/commit/74b138d2a6529f2c07729d7c77b1725a8e8b16f1))
    - tests/files/good-large_compressed.lzma ([cf44e4b7f5dfdbf8c78aef377c10f71e274f63c0](https://github.com/tukaani-project/xz/commit/cf44e4b7f5dfdbf8c78aef377c10f71e274f63c0), [74b138d2a6529f2c07729d7c77b1725a8e8b16f1](https://github.com/tukaani-project/xz/commit/74b138d2a6529f2c07729d7c77b1725a8e8b16f1))
  - Script called by `build-to-host.m4` after unpacking it from malicious test data which then modifies the build process.
  - IFUNC mechanism, which has legitimate purpose, but exploited to do runtime hooking/redirection
    of e.g. OpenSSH's authentication routines

* For compromised release tarballs (signed, not auto-generated by github from the git repository),
  a malicious version of `build-to-host.m4` is used to execute a script during the build process.

* The script, at least in xz-5.6.0 and xz-5.6.1, checks for various conditions like the architecture
  of the machine:
  >```if ! (echo "$build" | grep -Eq "^x86_64" > /dev/null 2>&1) && (echo "$build" | grep -Eq "linux-gnu$" > /dev/null 2>&1);then```

* ... the toolchain being used:
  > ```
  >   if test "x$GCC" != 'xyes' > /dev/null 2>&1;then
  >   exit 0
  >   fi
  >   if test "x$CC" != 'xgcc' > /dev/null 2>&1;then
  >   exit 0
  >   fi
  >   LDv=$LD" -v"
  >   if ! $LDv 2>&1 | grep -qs 'GNU ld' > /dev/null 2>&1;then
  >   exit 0
  > ```

* ... and whether it looks like a .deb or .rpm package is being built:
  > `if test -f "$srcdir/debian/rules" || test "x$RPM_ARCH" = "xx86_64";then`

## Payload

* The payload is only injected if the backdoor component of the build system, described above, triggered.
* The runtime payload has __not__ been analysed in detail yet.
* The payload definitely _at least_ does something if `argv[0] == /usr/bin/sshd`.
* It might do something in other cases. **We don't know yet!**
* Vanilla upstream openssh isn't affected unless one of its few dependencies loads _liblzma_. We are not aware of any cases of this.
* _Patched_ openssh for `systemd-notify` support _is_ affected if systemd is built with _lzma_ support, because `sshd` loads `libsystemd` which loads `liblzma`. Many distributions patch in this support.
  * See https://github.com/openssh/openssh-portable/pull/375.
* It is known that if it is loaded in openssh's `sshd`, `RSA_public_decrypt` will be redirected into a malicious implementation to bypass authentication.

## People

I do not want to speculate on people in this document. It is for law enforcement to handle identifying those responsible.

xz-utils has two maintainers:
* Lasse Collin (_Larzhu_) who has maintained xz since the beginning (~2009), and before that, `lzma-utils`.
* Jia Tan (_JiaT75_) who started contributing to xz in the last 2-2.5 years and gained commit access, and then release manager rights, about 1.5 years ago.

Lasse regularly has internet breaks and is on one at the moment, started before this all kicked off. We believe CISA may be trying to get in contact with him.

## Acknowledgements

* Andres Freund who discovered the issue and reported it to *linux-distros* and then *oss-security*.
* All the hard-working security teams helping to coordinate a response and push out fixes.

## References
* https://lwn.net/Articles/967180/
* https://www.openwall.com/lists/oss-security/2024/03/29/4